name: Build Tauri ARM64 and Upload

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Fix workspace permissions
        run: sudo chown -R ubuntu:ubuntu /home/ubuntu/actions-runner/_work

      - name: Checkout
        uses: actions/checkout@v3

      # IMPORTANT: Fix actual project directory inside runner
      - name: Fix ALL project permissions (Cargo fix)
        run: sudo chown -R ubuntu:ubuntu /home/ubuntu/actions-runner/_work/indi-touch-meter/indi-touch-meter

      # Fix cargo registry (sometimes root-owned)
      - name: Fix Cargo registry permissions
        run: sudo chown -R ubuntu:ubuntu /usr/local/cargo || true

      - name: Clean old build files
        run: rm -rf src-tauri/target/release/bundle || true

      - name: Build Docker image (cached)
        run: |
          cd ~/tauri-docker-build
          docker build \
            --cache-from=type=local,src=/home/ubuntu/docker-cache \
            --cache-to=type=local,dest=/home/ubuntu/docker-cache,mode=max \
            -t tauri-builder:bookworm .

      - name: Build Tauri App
        run: |
          cd $GITHUB_WORKSPACE

          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -e HOME=/app \
            -e NPM_CONFIG_USERCONFIG=/app/.npmrc \
            -v "$(pwd)":/app \
            -w /app \
            tauri-builder:bookworm \
            bash -c "
              mkdir -p /app/.npm &&
              echo 'cache=/app/.npm' > /app/.npmrc &&
              npm install &&
              npm run tauri build
            "

      - name: Upload to S3
        run: |
          FILE=$(ls src-tauri/target/release/bundle/deb/*.deb)
          aws s3 cp \"$FILE\" s3://apm-update/builds/
          echo \"BUILD_FILE=$(basename $FILE)\" >> $GITHUB_ENV

      - name: Send SES Email
        run: |
          LINK=\"https://apm-update.s3.amazonaws.com/builds/$BUILD_FILE\"

          aws ses send-email \
            --from \"ankur.auti@inditronics.com\" \
            --destination \"ToAddresses=ankurauti@gmail.com\" \
            --message \"Subject={Data=Tauri Build Completed},Body={Text={Data=New ARM64 build is ready:\n$LINK}}"
