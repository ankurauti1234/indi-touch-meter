name: Build Tauri ARM64 and Upload

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: self-hosted   # EC2 ARM64 GitHub Runner

    steps:
      # 1. Fix workspace directory permissions
      - name: Fix workspace permissions
        run: sudo chown -R ubuntu:ubuntu /home/ubuntu/actions-runner/_work

      # 2. Checkout repo
      - name: Checkout
        uses: actions/checkout@v3

      # 3. Clean previous builds
      - name: Clean old build files
        run: rm -rf src-tauri/target/release/bundle || true

      # 4. Build Docker image using CACHE
      - name: Build Docker image (cached)
        run: |
          cd ~/tauri-docker-build

          docker build \
            --cache-from=type=local,src=/home/ubuntu/docker-cache \
            --cache-to=type=local,dest=/home/ubuntu/docker-cache,mode=max \
            -t tauri-builder:bookworm .

      # 5. Build Tauri App inside Docker
      - name: Build Tauri App
        run: |
          cd $GITHUB_WORKSPACE

          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -e HOME=/app \
            -e NPM_CONFIG_USERCONFIG=/app/.npmrc \
            -v "$(pwd)":/app \
            -w /app \
            tauri-builder:bookworm \
            bash -c "
              echo '--- Fixing permissions ---'
              find /app -type d -exec chmod 755 {} \; &&
              find /app -type f -exec chmod 644 {} \; &&
              chown -R $(id -u):$(id -g) /app &&

              mkdir -p /app/.npm &&
              echo 'cache=/app/.npm' > /app/.npmrc &&

              echo '--- npm install ---'
              npm install &&

              echo '--- cargo metadata ---'
              cargo metadata --no-deps --format-version 1 &&

              echo '--- Building Tauri ---'
              npm run tauri build
            "

      # 6. Upload .deb file to S3
      - name: Upload to S3
        run: |
          FILE=$(ls src-tauri/target/release/bundle/deb/*.deb)
          aws s3 cp "$FILE" s3://apm-update/builds/
          echo "BUILD_FILE=$(basename $FILE)" >> $GITHUB_ENV

      # 7. Send SES Email notification
      - name: Send SES Email
        run: |
          LINK="https://apm-update.s3.amazonaws.com/builds/$BUILD_FILE"

          aws ses send-email \
            --from "ankur.auti@inditronics.com" \
            --destination "ToAddresses=ankurauti@gmail.com" \
            --message "Subject={Data=Tauri Build Completed},Body={Text={Data=New ARM64 build is ready:\n$LINK}}"
